<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dMess Web</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Modern Dark Theme Palette */
      --bg-dark: #0f172a;
      --bg-darker: #020617;
      --panel-bg: rgba(30, 41, 59, 0.6);
      --panel-border: rgba(148, 163, 184, 0.1);
      
      --primary: #6366f1; /* Indigo 500 */
      --primary-glow: rgba(99, 102, 241, 0.4);
      --accent: #8b5cf6; /* Violet 500 */
      
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      
      --success: #10b981;
      --danger: #ef4444;
      
      --glass-blur: blur(12px);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      background: radial-gradient(circle at top right, #1e1b4b, #0f172a 40%, #020617);
      color: var(--text-main);
      font-family: "Inter", sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

    /* Header */
    header {
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: var(--glass-blur);
      border-bottom: 1px solid var(--panel-border);
      z-index: 10;
    }

    .brand {
      font-weight: 700;
      font-size: 18px;
      background: linear-gradient(135deg, #818cf8, #c084fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .status-pill {
      margin-left: auto;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status-pill::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      box-shadow: 0 0 8px currentColor;
    }

    .info-group {
      display: flex;
      gap: 12px;
      font-size: 13px;
      color: var(--text-muted);
    }
    .info-item strong { color: var(--text-main); font-weight: 500; }

    /* Main Layout */
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 24px;
      padding: 24px;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
      height: calc(100vh - 70px);
    }

    /* Common Glass Panel */
    .glass-panel {
      background: var(--panel-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.2);
    }

    /* Sidebar */
    #sidebar {
      gap: 16px;
      padding: 16px;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .sidebar-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .icon-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 6px;
      border-radius: var(--radius-sm);
      transition: all 0.2s;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }

    #peers {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .peer {
      padding: 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
      background: rgba(255,255,255,0.02);
    }
    
    .peer:hover {
      background: rgba(255,255,255,0.05);
      transform: translateY(-1px);
    }
    
    .peer.active {
      background: rgba(99, 102, 241, 0.15);
      border-color: rgba(99, 102, 241, 0.3);
    }

    .peer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .peer-name { font-weight: 600; font-size: 14px; }
    .peer-id { font-size: 11px; color: var(--text-muted); font-family: monospace; }
    .peer-sig { font-size: 10px; color: var(--text-muted); opacity: 0.7; }

    /* Content Area */
    #content {
      position: relative;
    }

    #log {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
    }

    .msg {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
      position: relative;
      animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg.other {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.08);
      border-bottom-left-radius: 4px;
    }
    
    .msg.self {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .msg.error {
      align-self: center;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
      font-size: 13px;
    }

    .msg-meta {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 4px;
      font-size: 11px;
      opacity: 0.7;
    }
    
    .msg.self .msg-meta { color: rgba(255,255,255,0.8); }
    .msg.other .msg-meta { color: var(--text-muted); }

    .msg-sender { font-weight: 700; }

    /* Input Area */
    .input-area {
      padding: 20px;
      background: rgba(15, 23, 42, 0.6);
      border-top: 1px solid var(--panel-border);
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .input-group {
      display: flex;
      gap: 12px;
      flex: 1;
      background: rgba(0,0,0,0.2);
      padding: 4px;
      border-radius: var(--radius-md);
      border: 1px solid var(--panel-border);
    }

    input {
      background: transparent;
      border: none;
      color: var(--text-main);
      padding: 12px;
      font-size: 14px;
      font-family: inherit;
    }
    
    input:focus { outline: none; }
    
    #peer-input { width: 140px; border-right: 1px solid var(--panel-border); }
    #text-input { flex: 1; }

    button.send-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0 24px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      height: 48px;
      box-shadow: 0 0 15px var(--primary-glow);
    }
    
    button.send-btn:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }
    
    button.send-btn:active { transform: translateY(0); }

    .hint {
      position: absolute;
      bottom: 85px;
      left: 24px;
      font-size: 11px;
      color: var(--text-muted);
      pointer-events: none;
    }

    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; grid-template-rows: 200px 1fr; padding: 12px; gap: 12px; }
      header { padding: 12px; flex-wrap: wrap; }
      .info-group { display: none; } /* Hide extra info on mobile */
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">dMess Web</div>
    
    <div class="info-group">
      <div class="info-item">ID: <strong id="self-id">—</strong></div>
      <div class="info-item">Mode: <strong id="mode">—</strong></div>
      <div class="info-item" id="self-sig" style="opacity:0.6; font-size:11px;">Key: —</div>
    </div>

    <div class="status-pill" id="status">Connecting…</div>
  </header>

  <main>
    <section id="sidebar" class="glass-panel">
      <div class="sidebar-header">
        <span class="sidebar-title">Active Peers</span>
        <button class="icon-btn" id="refresh" title="Refresh Peers">↻</button>
      </div>
      <div id="peers">
        <!-- Peers injected here -->
      </div>
      <div style="padding: 12px; font-size: 11px; color: var(--text-muted); text-align: center; border-top: 1px solid var(--panel-border);">
        Auto-refreshing every 8s
      </div>
    </section>

    <section id="content" class="glass-panel">
      <div id="log">
        <!-- Messages injected here -->
      </div>
      
      <div class="hint">Sending to: <span id="active-peer" style="color:var(--primary)">none</span></div>

      <form id="send-form" class="input-area">
        <div class="input-group">
          <input id="peer-input" placeholder="Peer ID / Name" autocomplete="off" />
          <input id="text-input" placeholder="Type a message..." autocomplete="off" />
        </div>
        <button type="submit" class="send-btn">Send</button>
      </form>
    </section>
  </main>

  <script>
    const peersEl = document.getElementById("peers");
    const logEl = document.getElementById("log");
    const activePeerEl = document.getElementById("active-peer");
    const peerInput = document.getElementById("peer-input");
    const textInput = document.getElementById("text-input");
    const statusEl = document.getElementById("status");
    const selfEl = document.getElementById("self-id");
    const modeEl = document.getElementById("mode");
    const selfSigEl = document.getElementById("self-sig");
    
    let ws;
    let peers = {};
    let activePeer = null;
    let selfId = "";

    function addMsg({from, text, self=false, error=false}) {
      const div = document.createElement("div");
      div.className = "msg" + (self ? " self" : " other") + (error ? " error" : "");
      
      const now = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      // Sanitizing basic HTML just in case, though textContent is safer usually.
      // Here we trust the text content for simplicity but wrapping in structure.
      
      if (error) {
        div.textContent = text;
      } else {
        div.innerHTML = `
          <div class="msg-meta">
            <span class="msg-sender">${from}</span>
            <span class="msg-time">${now}</span>
          </div>
          <div class="msg-content">${text}</div>
        `;
      }
      
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setActivePeer(id) {
      activePeer = id;
      activePeerEl.textContent = id ? id : "none";
      document.querySelectorAll(".peer").forEach(el => {
        el.classList.toggle("active", el.dataset.id === id);
      });
      if (id) {
        peerInput.value = id;
        textInput.focus();
      }
    }

    function renderPeers(list) {
      peersEl.innerHTML = "";
      peers = {};
      list.forEach(p => { peers[p.id] = p.name || null; });
      
      if (list.length === 0) {
        peersEl.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-muted); font-size:13px;">No peers found</div>`;
        return;
      }

      list.forEach(p => {
        const el = document.createElement("div");
        el.className = "peer" + (p.id === activePeer ? " active" : "");
        el.dataset.id = p.id;
        
        const displayName = p.name || p.id.slice(0,12);
        const displayKey = p.sig_key ? p.sig_key.slice(0,8) + "..." : "—";
        
        el.innerHTML = `
          <div class="peer-header">
            <span class="peer-name">${displayName}</span>
          </div>
          <div class="peer-id">${p.id}</div>
          <div class="peer-sig">Key: ${displayKey}</div>
        `;
        
        el.onclick = () => setActivePeer(p.id);
        peersEl.appendChild(el);
      });
      
      if (!activePeer && list.length) {
        // Optional: Auto-select first peer if none selected
        // setActivePeer(list[0].id);
      }
    }

    async function loadPeers() {
      try {
        const res = await fetch("/api/peers");
        const data = await res.json();
        renderPeers(data.peers || []);
        statusEl.innerHTML = "Online";
        statusEl.style.color = "var(--success)";
        statusEl.style.borderColor = "rgba(16, 185, 129, 0.2)";
      } catch (e) {
        addMsg({from: "System", text: "Failed to load peers", error: true});
      }
    }

    async function sendMessage(peerOverride, textOverride) {
      const peer = peerOverride || peerInput.value.trim() || activePeer;
      const text = textOverride || textInput.value.trim();
      
      if (!peer || !text) {
        // Shake animation or visual feedback could go here
        return;
      }
      
      try {
        const res = await fetch("/api/send", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({peer, text})
        });
        
        if (!res.ok) {
          const t = await res.text();
          addMsg({from: "System", text: `Send failed: ${t}`, error: true});
        } else {
          addMsg({from: "Me", text, self: true});
          textInput.value = "";
        }
      } catch (e) {
        addMsg({from: "System", text: "Network error sending message", error: true});
      }
    }

    async function fetchSelf() {
      try {
        const res = await fetch("/api/self");
        const data = await res.json();
        selfId = data.peer_id;
        selfEl.textContent = selfId.slice(0,12);
        selfSigEl.textContent = `Key: ${data.sig_key ? data.sig_key.slice(0,16) + "..." : "—"}`;
        modeEl.textContent = data.mode.toUpperCase();
      } catch (e) {}
    }

    function connectWs() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}/ws`);
      
      ws.onopen = () => { 
        statusEl.textContent = "Connected";
        statusEl.style.color = "var(--success)";
      };
      
      ws.onmessage = ev => {
        const data = JSON.parse(ev.data);
        if (data.type === "welcome") {
          selfId = data.peer_id;
          selfEl.textContent = selfId.slice(0,12);
          selfSigEl.textContent = `Key: ${data.sig_key ? data.sig_key.slice(0,16) + "..." : "—"}`;
          modeEl.textContent = data.mode.toUpperCase();
          loadPeers();
        } else if (data.type === "msg") {
          addMsg({from: data.from_label || data.from.slice(0,12), text: data.text});
        }
      };
      
      ws.onclose = () => {
        statusEl.textContent = "Disconnected";
        statusEl.style.color = "var(--danger)";
        statusEl.style.borderColor = "var(--danger)";
        addMsg({from: "System", text: "WebSocket closed. Reload to reconnect.", error: true});
      };
    }

    document.getElementById("refresh").onclick = () => {
      const btn = document.getElementById("refresh");
      btn.style.transform = "rotate(360deg)";
      setTimeout(() => btn.style.transform = "none", 500);
      loadPeers();
    };
    
    document.getElementById("send-form").addEventListener("submit", ev => {
      ev.preventDefault();
      sendMessage();
    });

    // Initial Load
    setInterval(loadPeers, 8000);
    connectWs();
    fetchSelf();
    loadPeers();
  </script>
</body>
</html>
